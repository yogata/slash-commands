---
description: 要件を整理・定義する（機能追加・バグ修正共通）
---

# 要件定義

機能追加またはバグ修正の要件を整理・定義します。
文脈（機能追加/バグ修正）と規模（パターンA/B）を自動判定します。

## オプション

- `--feature` — 機能追加モード（デフォルト: 自動判定）
- `--bug` — バグ修正モード（デフォルト: 自動判定）

## 規模判定

### パターン一覧

| パターン    | 規模               | docs/更新 | ADR        | 判定方法 |
| ----------- | ------------------ | --------- | ---------- | -------- |
| **A（小）** | バグ修正・軽微変更 | なし      | なし       | 自動判定 |
| **B（中）** | 新機能追加         | あり      | スキル判定 | 自動判定 |

### 自動判定ロジック

```
ユーザーの入力から規模を自動判定:
- 「修正」「変更」「バグ」「エラー」「直したい」等 → パターンA
- 「追加」「新規」「作成」「実装」「機能」等 → パターンB
```

## 手順

### 文脈と規模の判定

ユーザーの入力から文脈と規模を自動判定:

**文脈（機能追加/バグ修正）**:

- 「作りたい」「追加」「実装」など → 機能追加
- 「エラー」「バグ」「動かない」「直したい」など → バグ修正

**規模（パターンA/B）**:

- 「修正」「変更」等のキーワード → パターンA
- 「追加」「新規」「作成」等のキーワード → パターンB

またはオプションで明示的に指定。

---

### A. パターンA（小規模・バグ修正・軽微変更）

docs/の更新は行いません。Issue本文のみを使用します。

1. **事象の確認**
   - ユーザーが貼り付けた情報（エラーメッセージ、ログ、スクリーンショット等）を確認する
   - 不足している情報があれば、ユーザーに追加情報を求める

2. **関連コードの特定**
   - エラーメッセージやスタックトレースから、関連するファイル・関数を特定する
   - `grep_search` や `codebase_search` を活用してコードベースを調査する

3. **根本原因の分析**
   - 問題が発生するメカニズムを推定する
   - 再現条件を整理する

4. **影響範囲の評価**
   - この問題が影響する機能・コンポーネントを洗い出す
   - 緊急度・重要度を評価する

5. **分析結果の報告**
   - 以下の構造でユーザーに報告する:
     - **事象の概要**: 何が起きているか
     - **根本原因**: なぜ起きているか
     - **影響範囲**: どこに影響するか
     - **推奨される対応**: どう対処すべきか

---

### B. パターンB（中規模・新機能追加）

docs/の更新（requirements.md、specifications.md（HLD）、ADR）を行います。

1. **機能の概要と目的**
   - どのような機能を作るのか？
   - なぜその機能が必要なのか？（ユーザーのベネフィットは何か？）

2. **要件の洗い出し**
   - **機能要件**: 具体的に何ができればよいか（UI/UX、API仕様、データ構造など）
   - **非機能要件**: パフォーマンス、セキュリティ、制約事項など

3. **スコープの定義**
   - 今回の実装対象範囲（Must Have）
   - 今回は対象外とする範囲（Out of Scope / Nice to Have）

4. **ADR作成要否の判定**
   - `adr-guidelines` スキルを使用してADR作成の必要性を判定する
   - スキルへの入力: 機能概要、要件、スコープ
   - スキルの出力に従う:
     - 「ADR作成推奨: [理由]」→ ADRを作成する（ステップ6で実施）
     - 「ADR不要: [理由]」→ ADR作成をスキップし、理由を出力に含める

5. **定義内容の報告と更新確認**
   - 以下の構造でユーザーに報告し、仕様書・ADRの更新を行ってよいか確認する:
     - **概要**: 機能の一言説明
     - **目的**: 解決する課題や価値
     - **要件リスト**: 箇条書きで列挙
     - **スコープ**: 対象/対象外の境界線
     - **更新予定のドキュメント**: requirements.md、specifications.md（HLD）、ADR（スキル判定で「推奨」の場合のみ）
     - **ADR判定結果**: スキル判定の結果と理由を含める
     - **確認**: 「以上の内容で仕様書を更新してよろしいでしょうか？（仕様書の更新までが issue-req の実施範囲です）」と尋ねる。
6. **仕様書・ADRの更新（ユーザー承認後）**
   - ユーザーから承認を得た後、以下のドキュメントを更新する:
   - `docs/requirements.md` に要件を追加する
   - `docs/specifications.md`（HLD）に概要レベルの仕様を追加する
     - アーキテクチャ、コンポーネント間の関係、データフロー
   - `docs/adr/NNN-xxx.md` を新規作成する（status: proposed）— **スキル判定で「ADR作成推奨」の場合のみ**

   **Specifications.md（HLD）テンプレート**:

   ```markdown
   ## {機能名}

   ### 概要

   {機能の概要}

   ### アーキテクチャ

   {システム全体の構造}

   ### コンポーネント間の関係

   {コンポーネント同士の依存関係やインターフェース}

   ### データフロー

   {データの流れ}
   ```

   **ADRテンプレート**:

   ```markdown
   # ADR-NNN: {タイトル}

   ## Context

   {背景・制約}

   ## Decision

   {決定内容}

   ## Alternatives

   {検討した代替案}

   ## Consequences

   {結果・影響}

   ## Status

   proposed
   ```

---

## 出力形式

### パターンA

```
## 事象の概要
[何が起きているか]

## 根本原因
[なぜ起きているか]

## 影響範囲
[どこに影響するか]

## 推奨される対応
[どう対処すべきか]

> ✅ パターンA（小規模）と判定しました。docs/の更新はありません。
> 次のステップ: `/issue-create` を使用してIssueに登録しますか？
```

### パターンB

```
## 概要
[機能の一言説明]

## 目的
[解決する課題や価値]

## 要件リスト
- [要件1]
- [要件2]

## スコープ
- 対象: [実装範囲]
- 対象外: [今回の実装対象外]

## 更新予定のドキュメント
 `docs/requirements.md`: [追加予定内容]
 `docs/specifications.md` (HLD): [追加予定内容]
 `docs/adr/NNN-xxx.md`: [ADR作成予定内容]（ADR作成推奨の場合のみ）

## ADR判定結果
 [ADR作成推奨/ADR不要]: [理由]

> ✅ パターンB（中規模）と判定しました。
> 以上の内容で仕様書を更新してよろしいでしょうか？（仕様書の更新までが issue-req の実施範囲です）

*(ユーザー承認後)*
> 仕様書を更新しました。[ADRを更新しました / ADRは不要と判定されたためスキップしました]
> 次のステップ: `/issue-create` を使用してIssueに登録しますか？
```

## 使用例

### パターンA（自動判定）

```
/issue-req
> ログイン時に500エラーが出る
# → パターンAと自動判定
```

### パターンB（自動判定）

```
/issue-req
> ユーザー管理機能を作りたい
# → パターンBと自動判定
# → 要件定義と仕様書更新案の提示
# → (ユーザー承認後) Draft更新（requirements.md、ADR）
```
